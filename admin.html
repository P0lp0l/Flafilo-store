<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø§Ø¯Ø§Ø±Ø© | Admin Panel</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body { font-family: 'Cairo', sans-serif; background: #0f0c29; background: linear-gradient(to right, #24243e, #302b63, #0f0c29); color: white; min-height: 100vh; padding: 20px; }
        .admin-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(15px); border-radius: 25px; border: 1px solid rgba(255, 255, 255, 0.1); padding: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); margin-bottom: 30px; }
        h2 { color: #ff4d94; font-weight: 700; text-shadow: 0 0 10px rgba(255, 77, 148, 0.5); }
        .form-control { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 12px; padding: 12px; }
        .btn-primary { background: linear-gradient(45deg, #ff4d94, #ff758c); border: none; border-radius: 12px; padding: 12px; font-weight: bold; }
        .password-container { position: relative; }
        .toggle-password { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #ff4d94; }
        .table { color: white; margin-top: 20px; }
        .table-img { width: 60px; height: 60px; object-fit: cover; border-radius: 10px; margin-right: 5px; }
        #login-section { max-width: 450px; margin: 100px auto; }
        #admin-content { display: none; }
        .upload-msg { color: #00d4ff; font-weight: bold; display: none; }
    </style>
</head>
<body>

<div id="login-section" class="admin-card">
    <h2 class="text-center mb-4">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
    <div class="mb-3"><input type="email" id="login-email" class="form-control" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"></div>
    <div class="mb-3 password-container">
        <input type="password" id="login-password" class="form-control" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <i class="fas fa-eye toggle-password" onclick="togglePass('login-password')"></i>
    </div>
    <button class="btn btn-primary w-100" onclick="login()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ù†</button>
</div>

<div id="admin-content" class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Flafilo Store</h2>
        <button class="btn btn-outline-light" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="admin-card">
        <h4>Ø¥Ø¶Ø§ÙØ© Ù‡Ø¯ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© (ØµÙˆØ± Ù…Ù† ØªÙ„ÙŠÙÙˆÙ†Ùƒ) âœ¨</h4>
        <div class="row g-3">
            <div class="col-md-4"><input type="text" id="p-name" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‡Ø¯ÙŠØ©"></div>
            <div class="col-md-3"><input type="number" id="p-price" class="form-control" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø¬.Ù…)"></div>
            <div class="col-md-5">
                <label class="small text-white-50">Ø§Ø®ØªØ± ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© Ø£Ùˆ Ø£ÙƒØ«Ø±:</label>
                <input type="file" id="p-files" class="form-control" accept="image/*" multiple>
            </div>
            <div id="upload-status" class="col-12 text-center upload-msg">Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ù„Ù…ØªØ¬Ø±... â³</div>
            <div class="col-12 text-center">
                <button class="btn btn-primary px-5" onclick="addProduct()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø¢Ù†</button>
            </div>
        </div>
    </div>

    <div class="admin-card">
        <h4>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ğŸ”</h4>
        <div class="row g-3 align-items-center">
            <div class="col-md-8 password-container">
                <input type="password" id="new-password" class="form-control" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
                <i class="fas fa-eye toggle-password" onclick="togglePass('new-password')"></i>
            </div>
            <div class="col-md-4"><button class="btn btn-warning w-100 fw-bold" onclick="updatePassword()">ØªØ­Ø¯ÙŠØ«</button></div>
        </div>
    </div>

    <div class="admin-card">
        <h4>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h4>
        <div class="table-responsive">
            <table class="table">
                <thead><tr><th>Ø§Ù„ØµÙˆØ±</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody id="product-list"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDBfSCT_wePT2RexgcxZaz9NT9gWmXxgz0",
        authDomain: "flafilo-store.firebaseapp.com",
        projectId: "flafilo-store",
        storageBucket: "flafilo-store.firebasestorage.app",
        messagingSenderId: "470812703135",
        appId: "1:470812703135:web:ee2359353b3ad64b36a5aa"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function togglePass(id) {
        const input = document.getElementById(id);
        input.type = input.type === "password" ? "text" : "password";
    }

    function showToast(msg, color) {
        Toastify({ text: msg, duration: 3000, gravity: "top", position: "center", style: { background: color, borderRadius: "10px" } }).showToast();
    }

    async function login() {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-password').value;
        try {
            await auth.signInWithEmailAndPassword(email, pass);
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
            showToast("Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙŠØ§ ÙŠÙˆØ³Ù ğŸ‘‹", "#25d366");
            loadProducts();
        } catch (error) { showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„ âŒ", "#ff4d4d"); }
    }

    // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ù…Ù† Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†
    async function addProduct() {
        const name = document.getElementById('p-name').value;
        const price = document.getElementById('p-price').value;
        const files = document.getElementById('p-files').files;
        const statusMsg = document.getElementById('upload-status');
        const apiKey = 'Ff535d677000fe55d5f463ccfdadc283'; // Ù…ÙØªØ§Ø­Ùƒ Ø§Ù„Ù„ÙŠ Ø¨Ø¹ØªÙ‡

        if(!name || !price || files.length === 0) return showToast("Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø§Ù„Ø®Ø§Ù†Ø§Øª ÙˆØ§Ø®ØªØ§Ø± Ø§Ù„ØµÙˆØ±! âš ï¸", "#ff9800");

        statusMsg.style.display = 'block';
        let imageUrls = [];

        try {
            // Ø±ÙØ¹ ÙƒÙ„ Ø§Ù„ØµÙˆØ± Ù„Ù€ ImgBB
            for (let file of files) {
                let formData = new FormData();
                formData.append('image', file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, { method: 'POST', body: formData });
                const data = await res.json();
                imageUrls.push(data.data.url);
            }

            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firestore ÙƒÙ‚Ø§Ø¦Ù…Ø© ØµÙˆØ±
            await db.collection("gifts").add({
                name,
                price,
                images: imageUrls, // Ù‡Ù†Ø§ Ø®Ø²Ù†Ù†Ø§ ÙƒÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù„ÙŠ Ø§Ø®ØªØ±ØªÙ‡Ø§
                createdAt: new Date()
            });

            statusMsg.style.display = 'none';
            showToast("ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù‡Ø¯ÙŠØ© Ø¨Ø§Ù„ØµÙˆØ± Ø¨Ù†Ø¬Ø§Ø­ ğŸ", "#25d366");
            location.reload();
        } catch (e) { 
            statusMsg.style.display = 'none';
            showToast("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ âŒ", "#ff4d4d"); 
        }
    }

    function loadProducts() {
        db.collection("gifts").orderBy("createdAt", "desc").onSnapshot(snap => {
            const list = document.getElementById('product-list');
            list.innerHTML = '';
            snap.forEach(doc => {
                const p = doc.data();
                // Ø¹Ø±Ø¶ Ø£ÙˆÙ„ ØµÙˆØ±Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                const firstImg = p.images ? p.images[0] : (p.image || ''); 
                list.innerHTML += `
                    <tr>
                        <td><img src="${firstImg}" class="table-img"> ${p.images ? '<small>+'+(p.images.length-1)+'</small>' : ''}</td>
                        <td>${p.name}</td>
                        <td>${p.price} Ø¬.Ù…</td>
                        <td><button class="btn btn-danger btn-sm" onclick="deleteProduct('${doc.id}')">Ø­Ø°Ù</button></td>
                    </tr>
                `;
            });
        });
    }

    async function deleteProduct(id) {
        if(confirm("Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù‡Ø¯ÙŠØ©ØŸ")) { await db.collection("gifts").doc(id).delete(); showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù âœ…", "#333"); }
    }

    async function updatePassword() {
        const user = auth.currentUser;
        const newPass = document.getElementById('new-password').value;
        if(newPass.length < 6) return showToast("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¶Ø¹ÙŠÙØ©! âš ï¸", "#ff9800");
        try { await user.updatePassword(newPass); showToast("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ğŸ”", "#25d366"); } catch (e) { showToast("Ø£Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ­Ø§ÙˆÙ„ Ø«Ø§Ù†ÙŠØ© âŒ", "#ff4d4d"); }
    }

    function logout() { auth.signOut(); location.reload(); }
</script>
</body>
</html>
